<?php class Controller_Login_Progress extends ypController {	public function Index() {		$this->loadLanguage('Login/Progress');		if (empty($this->Request->POST)) {			$this->redirect($this->Link->build('Login/Index', TRUE));		}		$this->Loader->controller('User/User');		if ($this->User->isLogin()) {			if($this->Request->REQUEST['redirect_to']) {				$redirect_to = urldecode($this->Request->GET['redirect_to']);			} else {				$redirect_to = $this->Link->build('User/Account', TRUE);			}			$this->redirect($redirect_to);		}		$this->_data['username'] = !empty($this->Request->POST['username']) ? $this->Request->POST['username'] : '';		$this->_data['password'] = !empty($this->Request->POST['password']) ? $this->Request->POST['password'] : '';		$this->_data['remember_me'] = ($this->Request->POST['remember_me']) ? TRUE : FALSE;		$this->_data['redirect_to'] = !empty($this->Request->POST['redirect']) ? $this->Request->POST['redirect'] : '';		$this->_data['isAdminLogin'] = ($this->Request->POST['admin_login'] == '1') ? TRUE : FALSE;		$this->_data['error']  = '';		$this->Cookie->setExpire(3600000);		$this->Loader->model('Login/Progress');		if (empty($this->_data['username'])) {			$this->_data['error'] = $this->_data['error_username_empty'];		} else {			$userInfo = $this->Model_Login_Progress->GetUserInfo($this->_data['username']);			if (!$userInfo) {				$this->_data['error'] = $this->_data['error_username_not_exists'];			} else {				if ($this->Crypt->passwordHash($this->_data['password'], $userInfo['salt']) != $userInfo['password']) {					$this->_data['error'] = $this->_data['error_password_wrong'];				} else {					$login = array();					$login['isAdmin'] = 'false';					// is admin, admin login success					if ($this->_data['isAdminLogin']) {						if ($userInfo['groupid'] != '4') {							$this->_data['error'] = $this->_data['error_not_permisson'];						} else {							$login['isAdmin'] = 'true';						}					}					if (empty($this->_data['error'])) {						// Login success, but wait :)						$login['time_login'] = $this->Request->time;						$login['username'] = $this->_data['username'];						$login['client'] = md5($this->Request->userAgent);						$login['hashkey'] = $this->Crypt->getUserSessionHash($login['username'], $login['time_login'], $login['client'], $login['isAdmin']);						// Set to session db						$this->Model_Login_Progress->setSessionClient($login);						if ($this->_data['remember_me']) {							$this->Cookie->set($login);						}						$this->Session->set($login);						$this->Session->set('isLogin', TRUE);						if (empty($this->_data['redirect_to'])) {							$this->_data['redirect_to'] = $this->Link->build('User/Account', TRUE);						}						//$this->setTemplate('module/Login/Redirect.php');						//$this->Response->setOutput($this->render());						$this->redirect(urldecode($this->_data['redirect_to']));					}				}			}		}		if (!empty($this->_data['error'])) {			$this->loadLanguage('Login/Form');			$this->Document->setTitle($this->_data['title']);			$this->setTemplate('module/Login/Form.php');			$this->setTemplateChild(array(				'System/Header',				'System/Footer'			));			$this->Response->setOutput($this->render());		}	}}