<?php class Controller_Login_Progress extends ypController {	public function Index() {		$this->loadLanguage('Login/Progress');		if (empty($this->Request->POST)) {			$this->redirect($this->Link->build('Login/Index', TRUE));		}		$this->Loader->controller('User/User');		if ($this->User->isLogin()) {			if($this->Request->REQUEST['redirect_to']) {				$redirect_to = urldecode($this->Request->GET['redirect_to']);			} else {				$redirect_to = $this->Link->build('User/Account', TRUE);			}			$this->redirect($redirect_to);		}		$this->_data['username'] = !empty($this->Request->POST['username']) ? $this->Request->POST['username'] : '';		$this->_data['password'] = !empty($this->Request->POST['password']) ? $this->Request->POST['password'] : '';		$this->_data['remember_me'] = ($this->Request->POST['remember_me']) ? TRUE : FALSE;		$this->_data['redirect_to'] = !empty($this->Request->POST['redirect']) ? $this->Request->POST['redirect'] : '';		$this->_data['isAdminLogin'] = ($this->Request->POST['admin_login'] == '1') ? TRUE : FALSE;		$this->_data['error']  = '';		$this->Loader->model('Login/Progress');		if (empty($this->_data['username'])) {			$this->_data['error'] = $this->_data['error_username_empty'];		} else {			$userInfo = $this->Model_Login_Progress->GetUserInfo($this->_data['username']);			if (!$userInfo) {				$this->_data['error'] = $this->_data['error_username_not_exists'];			} else {				if ($this->Crypt->passwordHash($this->_data['password'], $userInfo['salt']) != $userInfo['password']) {					$this->_data['error'] = $this->_data['error_password_wrong'];				} else {					if ($this->_data['remember_me']) {						$this->Cookie->set('userName', $this->_data['username']);						$this->Cookie->set('userLoginHash', $this->Crypt->userLoginInfoHash($this->_data['username']));					}					$this->Session->set('userName', $this->_data['username']);					$this->Session->set('userLoginHash', $this->Crypt->userLoginInfoHash($this->_data['username']));					$this->Session->set('isLogin', TRUE);					// is admin, admin login success					if ($this->_data['isAdminLogin']) {						if ($userInfo['groupid'] != '4') {							$this->_data['error'] = $this->_data['error_not_permisson'];						} else {							// Admin set							$this->Session->set('isAdmin', $this->_data['username']);							$this->Session->set('adminHash', $this->Crypt->userLoginInfoHash($this->_data['username']));							// And if remember							if ($this->_data['remember_me']) {								$this->Cookie->set('isAdmin', $this->_data['username']);								$this->Cookie->set('adminHash', $this->Crypt->userLoginInfoHash($this->_data['username']));							}						}					}					if (empty($this->_data['redirect_to'])) {						$this->_data['redirect_to'] = $this->Link->build('User/Account', TRUE);					}					//$this->setTemplate('module/Login/Redirect.php');					//$this->Response->setOutput($this->render());					$this->redirect(urldecode($this->_data['redirect_to']));				}			}		}		if (!empty($this->_data['error'])) {			$this->loadLanguage('Login/Form');			$this->Document->setTitle($this->_data['title']);			$this->setTemplate('module/Login/Form.php');			$this->setTemplateChild(array(				'System/Header',				'System/Footer'			));			$this->Response->setOutput($this->render());		}	}}